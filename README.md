<p align="center">
    <img src="gopher.png" alt="Gopher" width="150px">
</p>
<p align="center">
    <a href="https://pkg.go.dev/github.com/InfluxCommunity/influxdb3-go">
        <img src="https://pkg.go.dev/badge/github.com/InfluxCommunity/influxdb3-go.svg" alt="Go Reference">
    </a>
    <a href="https://goreportcard.com/report/github.com/InfluxCommunity/influxdb3-go">
        <img src="https://goreportcard.com/badge/github.com/InfluxCommunity/influxdb3-go" alt="Go Report Card">
    </a>
    <a href="https://github.com/InfluxCommunity/influxdb3-go/actions/workflows/codeql-analysis.yml">
        <img src="https://github.com/InfluxCommunity/influxdb3-go/actions/workflows/codeql-analysis.yml/badge.svg?branch=main" alt="CodeQL analysis">
    </a>
    <a href="https://github.com/InfluxCommunity/influxdb3-go/actions/workflows/linter.yml">
        <img src="https://github.com/InfluxCommunity/influxdb3-go/actions/workflows/linter.yml/badge.svg" alt="Lint Code Base">
    </a>
    <a href="https://dl.circleci.com/status-badge/redirect/gh/InfluxCommunity/influxdb3-go/tree/main">
        <img src="https://dl.circleci.com/status-badge/img/gh/InfluxCommunity/influxdb3-go/tree/main.svg?style=svg" alt="CircleCI">
    </a>
    <a href="https://codecov.io/gh/InfluxCommunity/influxdb3-go">
        <img src="https://codecov.io/gh/InfluxCommunity/influxdb3-go/branch/main/graph/badge.svg" alt="Code Cov"/>
    </a>
    <a href="https://app.slack.com/huddle/TH8RGQX5Z/C02UDUPLQKA">
        <img src="https://img.shields.io/badge/slack-join_chat-white.svg?logo=slack&style=social" alt="Community Slack">
    </a>
</p>

# InfluxDB v3 Go client

The Go package that provides an easy and convenient way to interact with [InfluxDB v3](https://www.influxdata.com/get-influxdb/), the time series data platform designed to handle high write and query workloads.

Use this package to write and query data stored in an InfluxDB v3 database or bucket.
Query using SQL or InfluxQL and retrieve data in [Arrow Columnar Format](https://arrow.apache.org/docs/format/Columnar.html#format-ipc) using InfluxDB's native Flight RPC API.

## Prerequisites

### InfluxDB v3 credentials

Before you start, you'll need the following credentials for writing and query data in your InfluxDB v3 instance:

- **`https://cluster.influxdata.io/`**: the Host URL of your InfluxDB instance--for example, the Cloud Serverless region URL `https://us-east-1-1.aws.cloud2.influxdata.com/`.
- **`INFLUX_DATABASE`**: the name of the database or Cloud Serverless bucket where you want to write or query data.
- **`INFLUX_TOKEN`**: a database token (generated by your InfluxDB instance) with read/write permission to the specified database.

You'll use these credentials in a later step.

## Install the package

### In a Go module

1. In your terminal, create a module for your project--for example:

   ```sh
   go mod init iot-starter && cd $_
   ```

2. Install the latest version of the InfluxDB client:

<!--pytest-codeblocks:cont-->

   ```sh
   go get github.com/InfluxCommunity/influxdb3-go
   ```

### Outside a module (standalone)

```sh
go install github.com/InfluxCommunity/influxdb3-go@latest
```

## Usage

In a Go file, import the `influxdb3` package to use it in your code--for example:

```go
import (
  "context"
  "encoding/json"
  "fmt"
  "os"

  "github.com/InfluxCommunity/influxdb3-go/influxdb3"
)
```

### Instantiate a client

`influxdb3.Client` is the entrypoint for writing or querying data in InfluxDB.

To instantiate a client, choose one of the following ways to provide your InfluxDB credentials (URL, token, and database):

- [Instantiate using a configuration object][#instantiate-using-a-configuration-object]
- [Instantiate using a connection string](#instantiate-using-a-connection-string)
- [Instantiate using environment variables](#instantiate-using-environment-variables)

### Instantiate using a configuration object

Call the `influxdb3.New(config influxdb3.ClientConfig)` function with a `ClientConfig` struct that contains your [credentials](#influxdb-v3-credentials)--for example:

   ```go
   // Instantiate the client.
   client, err := influxdb3.New(influxdb3.ClientConfig{
       Host:     "https://cluster.influxdata.io/",
       Token:    "INFLUX_TOKEN",
       Database: "INFLUX_DATABASE",
   })
   ```

Replace the following values with your own [credentials](#influxdb-v3-credentials):

- `https://cluster.influxdata.io/`
- `INFLUX_TOKEN`
- _Optional_ `INFLUX_DATABASE`.
  Alternatively, you can omit `Database` and use `WriteOptions` or `QueryOptions` to specify the database name.

### Instantiate using a connection string

Call the `influxdb3.NewFromConnectionString(connectionString string)` function with a connection string that contains your credentials in URL format--for example:

```go
// Instantiate the client.
client, err := influxdb3.NewFromConnectionString(
       "https://cluster.influxdata.io/?token=INFLUX_TOKEN&database=INFLUX_DATABASE"
)
```

Replace the following values with your own [credentials](#influxdb-v3-credentials):

- `https://cluster.influxdata.io/`
- `INFLUX_TOKEN`
- _Optional_ `INFLUX_DATABASE`.
  Alternatively, you can omit `Database` and use `WriteOptions` or `QueryOptions` to specify the database name.

### Instantiate using environment variables

1. Set the following environment variables to store your InfluxDB credentials:

   <details>
     <summary>linux/macos</summary>

   ```sh
   export INFLUX_URL="https://cluster.influxdata.io/"
   export INFLUX_TOKEN="<INFLUX_TOKEN>"
   export INFLUX_DATABASE="<INFLUX_DATABASE>"
   ```

   </details>

   <details>
     <summary>windows</summary>

   ```powershell
   setx INFLUX_URL "https://cluster.influxdata.io/"
   setx INFLUX_TOKEN "<INFLUX_TOKEN>"
   setx INFLUX_DATABASE "<INFLUX_DATABASE>"
   ```

   </details>

Replace the following values with your own [credentials](#influxdb-v3-credentials):

- `https://cloud2.influxdata.com/`
- `<INFLUX_TOKEN>`
- _Optional_ `<INFLUX_DATABASE>`.
  Alternatively, you can omit `Database` and use `WriteOptions` or `QueryOptions` to specify the database name.

2. Call `influxdb3.Client.NewFromEnv()` to instantiate a client using the environment variables.

   ```go
   // Create a new client using INFLUX_* environment variables
   client, err := influxdb3.NewFromEnv()
   ```

### Close the client

In your code, make sure to call `client.Close()` when you have finished using the client.
You can use Go's `defer` to close the client and raise any errors before your function exits--for example:

```go
// Create a new client using INFLUX_* environment variables
client, err := influxdb3.NewFromEnv()

// Close the client when finished.
// Go calls the `defer` function before exiting.
defer func ()  {
    err := client.Close()
    if err != nil {
        panic(err)
    }
}()
```

### Write data

You can provide data as line protocol or you can use `Point` or `struct` to construct your data, and then let `influxdb3` convert it to line protocol for you.

The `influxdb3.Client` writes (inserts) all data as [line-protocol](https://docs.influxdata.com/influxdb/cloud-serverless/reference/syntax/line-protocol/) format to InfluxDB.

#### Using line protocol

You can provide "raw" line protocol to write:

```go
line := "stat,location=Paris temperature=23.5,humidity=45i"
err = client.Write(context.Background(), []byte(line))
```

#### Using a `Point`

You can use the client to construct points and convert them to line protocol:

```go
p1 := influxdb3.Point{
    influxdb3.NewPoint("stat",
        map[string]string{
            "location": "Paris",
        },
        map[string]any{
            "temperature": 24.5,
            "humidity":    40,
        },
        time.Now(),
    ),
}
points := []*influxdb3.Point{p1}
err = client.WritePoints(context.Background(), points)
```

#### Using an annotated struct

You can define data using Go structs and convert them to line protocol:

```go
s1 := struct {
    Measurement string    `lp:"measurement"`
    Sensor      string    `lp:"tag,location"`
    Temp        float64   `lp:"field,temperature"`
    Hum         int       `lp:"field,humidity"`
    Time        time.Time `lp:"timestamp"`
    Description string    `lp:"-"`
}{
    "stat",
    "Paris",
    23.5,
    55,
    time.Now(),
    "Paris weather conditions",
}
data := []any{s1}
err = client.WriteData(context.Background(), data)
```

### Query

Use SQL or InfluxQL to query an InfluxDB v3 database (or Cloud Serverless bucket) and retrieve data in Arrow Columnar format.
By default, the client sends the query as SQL.

`influxdb3` provides an iterator that you can use to process data by row--for example:

```go
query := `
    SELECT *
    FROM stat
    WHERE
        time >= now() - interval '5 minutes'
        AND
        location IN ('Paris')
`

iterator, err := client.Query(context.Background(), query)
if err != nil {
    panic(err)
}

for iterator.Next() {
    value := iterator.Value()

    fmt.Printf("temperature in Paris is %f\n", value["temperature"])
    fmt.Printf("humidity in Paris is %d%%\n", value["humidity"])
}
```

To query using InfluxQL, call the `Query()` function and specify `influxdb3.WithQueryType(influxdb3.InfluxQL)` in `options`--for example:

```go
query := `
    SELECT *
    FROM stat
    WHERE
        time >= now() - 
        AND
        location IN ('Paris')
`

iterator, err := client.Query(context.Background(), query)
if err != nil {
    panic(err)
}
```

You can use parameterized queries for SQL or InfluxQL.
Call the `QueryWithParameters()` function and pass the query text and a `QueryParameters` struct that defines parameter name-value pairs.

### Parameterized query with SQL

```go
...

// Specify $parameter placeholders in WHERE predicate expressions.
query := `
    SELECT *
    FROM stat
    WHERE
        time >= now() - interval '5 minutes'
        AND
        location = $location
`

// Assign parameter names to values.
parameters := influxdb3.QueryParameters{
    "location": "Paris",
}

iterator, err := client.QueryWithParameters(context.Background(), query, parameters)

// Process the result
```

#### Parameterized query with InfluxQL

```go
...
// Specify $parameter placeholders in WHERE predicate expressions.
query := `
    SELECT *
    FROM stat
    WHERE
        time >= now() - '5m'
        AND
        location = $location
`

// Assign parameter names to values.
parameters := influxdb3.QueryParameters{
    "location": "Paris",
}

// Specify the query type for an InfluxQL query
iterator, err := client.QueryWithParameters(context.Background(), query, parameters,
 influxdb3.WithQueryType(influxdb3.InfluxQL))

// Process result
```

For more information about **parameterized queries**, see the [InfluxDB documentation](https://docs.influxdata.com/)

## Run examples

To try more examples:

1. Follow instructions to [Install in a Go module](#install-in-a-go-module).
2. Clone this project or copy examples from the ['examples'](./examples/README.md) folder to your system.
3. Configure your  contains complete code examples that you can run.
Before Prepare environment like in [Usage](#usage) and 

## Feedback

If you need help, please use our [Community Slack](https://app.slack.com/huddle/TH8RGQX5Z/C02UDUPLQKA)
or [Community Page](https://community.influxdata.com/).

New features and bugs can be reported on GitHub: <https://github.com/InfluxCommunity/influxdb3-go>

## Contribution

If you would like to contribute code you can do through GitHub by forking the repository and sending a pull request into
the `main` branch.

## License

The InfluxDB 3 Go Client is released under the [MIT License](https://opensource.org/licenses/MIT).
which allows you to execute SQL queries on InfluxDB IOx.
